<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="/img/AAA.png">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">


  
<link rel="stylesheet" href="/css/style.css">


  
  <title>Understanding LevelDB Iterator - Auzdora&#39;s Blog</title>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  <header>
    <nav id="navbar" class="navbar fixed-nav scrolling-navbar">
  <div class="container">
    <div class="mark-wrapper">
       
      <div class="title-mark">Auzdora</div>
    </div>
  
    <button id="menu-btn" class="btn menu-btn" type="button" data-bs-toggle="collapse" data-bs-target="#nav-menu">
      <div class="menu-icon"><span></span><span></span><span></span></div>
    </button>
  
    <div id="nav-menu" class="collapse menu-wrapper">
      <ul>
        
          <li>
            <a href="/">Home </a>
          </li>
        
          <li>
            <a href="/archives">Archives </a>
          </li>
        
          <li>
            <a href="/Life">Life </a>
          </li>
        
          <li>
            <a href="/tag">Tag </a>
          </li>
        
          <li>
            <a href="/about2">About </a>
          </li>
        
        <li class="search-icon">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#searchModal" aria-label="Search">
            <i class="fas fa-search"></i>
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

  </header>

  <main>
    <div class="container">
      <div id="main">
        <div class="row py-5">
          <div class="col">
            <div class="row">
  <div class="left-content">
    <article class="post-wrapper markdown-body">
  <h2 class="post-title">
    Understanding LevelDB Iterator
  </h2>
  <div class="post-meta">
    <time datetime="Invalid date Invalid date ">2024-04-22</time>
    
    
       
    
    
      
        <a class="tag" href="/tags/LevelDB/">LevelDB</a> 
       
    
    
  </div>
  
  <div id="content">
    <h3 id="intro">Intro</h3>
<h4 id="understanding-iterators">Understanding Iterators</h4>
<p>Before diving into the specifics of LevelDB, let's clarify what an
iterator is in the context of programming. An iterator is an object that
enables users to traverse a container, particularly lists and arrays,
without exposing the underlying structure of the data. Iterators are
fundamental for accessing the elements of a data structure sequentially,
without needing to understand how the structure organizes its elements
internally.</p>
<h4 id="why-leveldb-uses-iterators">Why LevelDB Uses Iterators</h4>
<p>LevelDB, a fast key-value storage library written by Google, employs
iterators extensively. The design of LevelDB is such that it stores data
in sorted order using an efficient disk-based data structure inspired by
Log-Structured Merge-trees (LSM trees). This sorted arrangement makes it
essential to have a robust system for traversing the data entries
efficiently — hence, the use of iterators.</p>
<p>Iterators in LevelDB are crucial for several reasons:</p>
<ol type="1">
<li><strong>Efficient Data Retrieval:</strong> They allow the
application to access stored data in a sorted manner without loading the
entire data set into memory. This is particularly beneficial for large
data sets that do not fit entirely in RAM.</li>
<li><strong>Abstraction:</strong> LevelDB iterators abstract the
complexity of the underlying data structure. The user of the library
does not need to know about the internals of the SSTables (Sorted String
Tables) or the memtables. Instead, they interact with a clean, simple
API that the iterator provides.</li>
</ol>
<p>In the following sections, we will explore how LevelDB implements its
iterator interface, the functionalities it supports, and how iterators
in LevelDB organized. The content below represents my personal
understanding of the LevelDB iterator, so it may contain some flaws or
misunderstandings. If you find any, please contact me through any social
media platform. I'm very happy to discuss about it.</p>
<p><br></p>
<h3 id="usage-of-the-api">Usage of the API</h3>
<p>In LevelDB, the iterator is a powerful tool for traversing all the
data within the database. From a user's perspective, APIs should be
straightforward and user-friendly. Naturally, before delving deeper into
how something works, it's essential to learn how to use it. Below, I
outline some basic scenarios in which the LevelDB iterator can be
utilized.</p>
<h4 id="creating-and-using-an-iterator">Creating and Using an
Iterator</h4>
<p>To create an iterator in LevelDB, call the <code>NewIterator</code>
method. This process is akin to how iterators are used in C++ to scan
through data:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">leveldb<span class="token double-colon punctuation">::</span>Iterator<span class="token operator">*</span> it <span class="token operator">=</span> db<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>leveldb<span class="token double-colon punctuation">::</span><span class="token function">ReadOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>it<span class="token operator">-></span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">-></span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  cout <span class="token operator">&lt;&lt;</span> it<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> it<span class="token operator">-></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>it<span class="token operator">-></span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Check for any errors found during the scan</span>
<span class="token keyword">delete</span> it<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="starting-from-a-specific-point">Starting From a Specific
Point</h4>
<p>It is also possible to initiate the iterator at a specific starting
point in the database:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span>it<span class="token operator">-></span><span class="token function">Seek</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
     it<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> it<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> limit<span class="token punctuation">;</span>
     it<span class="token operator">-></span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Perform actions with each entry</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="reverse-scanning">Reverse Scanning</h4>
<p>Furthermore, LevelDB's iterator can scan the data in reverse,
starting from the last entry and moving to the first:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span>it<span class="token operator">-></span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">-></span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Actions to be performed on each entry</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><br></p>
<h3 id="high-level-overview">High level Overview</h3>
<p>Let's see how excatly iterator abstractions are orgnized in LevelDB
source code.</p>
<p>#TODO</p>
<ul class="task-list">
<li><label><input type="checkbox" /> Draw the high level
figure</label></li>
<li><label><input type="checkbox" /> Explain every part</label></li>
</ul>
<p><br></p>
<h3 id="iterator-abstraction">Iterator Abstraction</h3>
<p>Iterator is a base class for many iterators within LevelDB. It
provides a general interface that users can utilize. Basic access
methods such as <code>Seek()</code>, <code>Valid()</code>,
<code>SeekToFirst()</code>, <code>SeekToLast()</code>,
<code>Next()</code>, <code>Prev()</code>, <code>Key()</code>, and
<code>Value()</code> are provided. These are all pure virtual functions
which need to be implemented in the inheriting class.</p>
<p>One more thing about this base class is that it allows higher-level
code to register a cleanup function that will be invoked when an
iterator is destroyed.</p>
<p><br></p>
<h3 id="three-basic-iterator---memtable-iterator">Three Basic Iterator -
Memtable Iterator</h3>
<p>Memtable iterator is built on top of iterator abstraction, it's an
encapsulation of SkipList iterator.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MemTableIterator</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Iterator</span></span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">MemTableIterator</span><span class="token punctuation">(</span>MemTable<span class="token double-colon punctuation">::</span>Table<span class="token operator">*</span> table<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">iter_</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

  <span class="token function">MemTableIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> MemTableIterator<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  MemTableIterator<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> MemTableIterator<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">MemTableIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> k<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> iter_<span class="token punctuation">.</span><span class="token function">Seek</span><span class="token punctuation">(</span><span class="token function">EncodeKey</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp_<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> iter_<span class="token punctuation">.</span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> iter_<span class="token punctuation">.</span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> iter_<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> iter_<span class="token punctuation">.</span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  Slice <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span>iter_<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  Slice <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    Slice key_slice <span class="token operator">=</span> <span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span>iter_<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span>key_slice<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> key_slice<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  MemTable<span class="token double-colon punctuation">::</span>Table<span class="token double-colon punctuation">::</span>Iterator iter_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string tmp_<span class="token punctuation">;</span>  <span class="token comment">// For passing to EncodeKey</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><br></p>
<h3 id="three-basic-iterator---block-iterator">Three Basic Iterator -
Block Iterator</h3>
<p>The Block iterator is implemented in <code>block.cc</code> and
inherits from the Iterator abstraction. The essence of this class lies
in overriding all the virtual functions of the Iterator. To comprehend
how the iterator calculates, it's essential first to understand how data
blocks are organized. The image below depicts the layout of a data
block.</p>
<p align="center">
<img src="lv4.png" width="650">
</p>
<p>As illustrated, a restart point stores the offset of an actual data
entry (you can also think of it as a pointer pointing to a data entry).
The length records how many restart points this data block contains.</p>
<p>In the implementation of the block iterator, there are some key
meta-information pieces that we should pay attention to:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Block</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">Iter</span> <span class="token operator">:</span> <span class="token keyword">public</span> <span class="token class-name">Iterator</span></span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">const</span> Comparator<span class="token operator">*</span> <span class="token keyword">const</span> comparator_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> data_<span class="token punctuation">;</span>       <span class="token comment">// underlying block contents</span>
  <span class="token keyword">uint32_t</span> <span class="token keyword">const</span> restarts_<span class="token punctuation">;</span>      <span class="token comment">// Offset of restart array (list of fixed32)</span>
  <span class="token keyword">uint32_t</span> <span class="token keyword">const</span> num_restarts_<span class="token punctuation">;</span>  <span class="token comment">// Number of uint32_t entries in restart array</span>

  <span class="token comment">// current_ is the offset in data_ of the current entry.  >= restarts_ if !Valid</span>
  <span class="token keyword">uint32_t</span> current_<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> restart_index_<span class="token punctuation">;</span>  <span class="token comment">// Index of restart block in which current_ falls</span>
  std<span class="token double-colon punctuation">::</span>string key_<span class="token punctuation">;</span>
  Slice value_<span class="token punctuation">;</span>
  Status status_<span class="token punctuation">;</span>

  <span class="token comment">// other code ....</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>data_</code> points to the beginning of the block as shown
above. <code>restarts_</code> points to the beginning of the restart
points. <code>num_restarts_</code> equals the length.
<code>current_</code> and <code>restart_index_</code> help us navigate
within the data block. The following function is quite important:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">uint32_t</span> <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span> num_restarts_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">DecodeFixed32</span><span class="token punctuation">(</span>data_ <span class="token operator">+</span> restarts_ <span class="token operator">+</span> index <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>The input parameter <code>index</code> indicates the ith restart
point. In this function, we perform some simple offset calculation and
decode the data entry offset, then return it. With this function, we can
now jump to any restart point we desire within this data block.</p>
<p>Navigating with <code>Prev()</code> and <code>Next()</code></p>
<p>In <code>Next()</code>, the function calls
<code>ParseNextKey()</code>. This includes some shared or non-shared
elements, which we don't discuss in this blog; we can simply consider it
as an entry to help us focus on the iterator implementation. The idea
behind this function is straightforward. We first calculate the next
data entry address. If it's beyond the data entry limit, return false.
Otherwise, decode this entry, set the value and key, and update the
restart_index when necessary (e.g., assume the current data entry is the
end of restart point 0 block; when we call
<code>NextEntryOffset()</code>, the current data entry is in restart
point 1 field now, so we need to update the restart index too).</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">bool</span> <span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    current_ <span class="token operator">=</span> <span class="token function">NextEntryOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p <span class="token operator">=</span> data_ <span class="token operator">+</span> current_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> limit <span class="token operator">=</span> data_ <span class="token operator">+</span> restarts_<span class="token punctuation">;</span>  <span class="token comment">// Restarts come right after data</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">>=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// No more entries to return.  Mark as invalid.</span>
      current_ <span class="token operator">=</span> restarts_<span class="token punctuation">;</span>
      restart_index_ <span class="token operator">=</span> num_restarts_<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Decode next entry</span>
    <span class="token keyword">uint32_t</span> shared<span class="token punctuation">,</span> non_shared<span class="token punctuation">,</span> value_length<span class="token punctuation">;</span>
    p <span class="token operator">=</span> <span class="token function">DecodeEntry</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shared<span class="token punctuation">,</span> <span class="token operator">&amp;</span>non_shared<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> key_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> shared<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">CorruptionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      key_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
      key_<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
      value_ <span class="token operator">=</span> <span class="token function">Slice</span><span class="token punctuation">(</span>p <span class="token operator">+</span> non_shared<span class="token punctuation">,</span> value_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>restart_index_ <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> num_restarts_ <span class="token operator">&amp;&amp;</span>
             <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span>restart_index_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> current_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">++</span>restart_index_<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>In <code>Prev()</code>, because in a data block, data entries are
searched based on the 'restart point block'. A restart point will
contain a number of data entries, for example, 4. And in the image
below, assume we are now at entry 2 and we want to get to entry 1. Since
we don't have any information on how long an entry is, we cannot simply
subtract the length of entry 1 to get to entry 1. The only way to do
<code>Prev()</code> is to find the restart point of this 'restart point
block' and then sequentially search and stop before entry 2.</p>
<p align="center">
<img src="lv5.png" width="650">
</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Scan backwards to a restart point before current_</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> original <span class="token operator">=</span> current_<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Get

<span class="token function">RestartPoint</span><span class="token punctuation">(</span>restart_index_<span class="token punctuation">)</span> <span class="token operator">>=</span> original<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>restart_index_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// No more entries</span>
        current_ <span class="token operator">=</span> restarts_<span class="token punctuation">;</span>
        restart_index_ <span class="token operator">=</span> num_restarts_<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      restart_index_<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">SeekToRestartPoint</span><span class="token punctuation">(</span>restart_index_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Loop until the end of the current entry hits the start of the original entry</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">NextEntryOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> original<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>How Does <code>Seek()</code> Function Work?</p>
<p><code>Seek()</code> has one single parameter which is the target. The
target is the key we want to find in this data block. The simple idea is
that we can compare the key entry by entry until we find the entry we
want. But remember data entries are divided into many restart point
blocks? So we can first use a restart point to search the restart point
block that the target might locate in, using binary search. Once we find
the specific restart point block, we can use linear search to walk
through and find the target.</p>
<p align="center">
<img src="lv6.png" width="650">
</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> target<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Binary search in restart array to find the last restart point</span>
  <span class="token comment">// with a key &lt; target</span>
  <span class="token keyword">uint32_t</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> right <span class="token operator">=</span> num_restarts_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> current_key_compare <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// If we're already scanning, use the current position as a starting</span>
    <span class="token comment">// point. This is beneficial if the key we're seeking to is ahead of the</span>
    <span class="token comment">// current position.</span>
    current_key_compare <span class="token operator">=</span> <span class="token function">Compare</span><span class="token punctuation">(</span>key_<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current_key_compare <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// key_ is smaller than target</span>
      left <span class="token operator">=</span> restart_index_<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current_key_compare <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      right <span class="token operator">=</span> restart_index_<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// We're seeking to the key we're already at.</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">uint32_t</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> region_offset <span class="token operator">=</span> <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> shared<span class="token punctuation">,</span> non_shared<span class="token punctuation">,</span> value_length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> key_ptr <span class="token operator">=</span>
        <span class="token function">DecodeEntry</span><span class="token punctuation">(</span>data_ <span class="token operator">+</span> region_offset<span class="token punctuation">,</span> data_ <span class="token operator">+</span> restarts_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shared<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>non_shared<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key_ptr <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> <span class="token punctuation">(</span>shared <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">CorruptionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    Slice <span class="token function">mid_key</span><span class="token punctuation">(</span>key_ptr<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Compare</span><span class="token punctuation">(</span>mid_key<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Key at "mid" is smaller than "target".  Therefore all</span>
      <span class="token comment">// blocks before "mid" are uninteresting.</span>
      left <span class="token operator">=</span> mid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Key at "mid" is >= "target".  Therefore all blocks at or</span>
      <span class="token comment">// after "mid" are uninteresting.</span>
      right <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// We might be able to use our current position within the restart block.</span>
  <span class="token comment">// This is true if we determined the key we desire is in the current block</span>
  <span class="token comment">// and is after than the current key.</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>current_key_compare <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> skip_seek <span class="token operator">=</span> left <span class="token operator">==</span> restart_index_ <span class="token operator">&amp;&amp;</span> current_key_compare <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip_seek<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SeekToRestartPoint</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// Linear search (within restart block) for first key >= target</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Compare</span><span class="token punctuation">(</span>key_<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><br></p>
<h3 id="three-basic-iterator---levelfilenum-iterator">Three Basic
Iterator - LevelFileNum Iterator</h3>
<p>LevelFileNum Iterator also build on top of Iterator abstraction. It
enables user ability to navigate through files within a level. Assume
that we create a LevelFileNum Iterator on level 0. And level 0 contains
10 files. To navigate through this level, we just need to maintain an
index number and the pointer to this level file vector. We can then get
key or value based on these information.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// An internal iterator.  For a given version/level pair, yields</span>
<span class="token comment">// information about the files in the level.  For a given entry, key()</span>
<span class="token comment">// is the largest key that occurs in the file, and value() is an</span>
<span class="token comment">// 16-byte value containing the file number and file size, both</span>
<span class="token comment">// encoded using EncodeFixed64.</span>
<span class="token keyword">class</span> <span class="token class-name">Version</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">LevelFileNumIterator</span> <span class="token operator">:</span> <span class="token keyword">public</span> <span class="token class-name">Iterator</span></span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">LevelFileNumIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> InternalKeyComparator<span class="token operator">&amp;</span> icmp<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> flist<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">icmp_</span><span class="token punctuation">(</span>icmp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flist_</span><span class="token punctuation">(</span>flist<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">index_</span><span class="token punctuation">(</span>flist<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Marks as invalid</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">bool</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> index_ <span class="token operator">&lt;</span> flist_<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> target<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    index_ <span class="token operator">=</span> <span class="token function">FindFile</span><span class="token punctuation">(</span>icmp_<span class="token punctuation">,</span> <span class="token operator">*</span>flist_<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> index_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    index_ <span class="token operator">=</span> flist_<span class="token operator">-></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> flist_<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    index_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      index_ <span class="token operator">=</span> flist_<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Marks as invalid</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      index_<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  Slice <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>flist_<span class="token punctuation">)</span><span class="token punctuation">[</span>index_<span class="token punctuation">]</span><span class="token operator">-></span>largest<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  Slice <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>value_buf_<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>flist_<span class="token punctuation">)</span><span class="token punctuation">[</span>index_<span class="token punctuation">]</span><span class="token operator">-></span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>value_buf_ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>flist_<span class="token punctuation">)</span><span class="token punctuation">[</span>index_<span class="token punctuation">]</span><span class="token operator">-></span>file_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Slice</span><span class="token punctuation">(</span>value_buf_<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>value_buf_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">const</span> InternalKeyComparator icmp_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> <span class="token keyword">const</span> flist_<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> index_<span class="token punctuation">;</span>

  <span class="token comment">// Backing store for value().  Holds the file number and size.</span>
  <span class="token keyword">mutable</span> <span class="token keyword">char</span> value_buf_<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><br></p>
<h3 id="two-level-iterator">Two level iterator</h3>
<p>Two-level iterators provide a general interface for <strong>table
iterators</strong> and <strong>concatenating iterators</strong> (we will
see how these two are implemented later). There are two iterators in the
two-level iterator design. The basic idea behind this is that when we
iterate, we first use an index iterator to locate the exact block data
we need. We then call a block function to build the block iterator based
on the block we searched, and subsequently iterate over this block
iterator. Pretty simple and straightforward, right? However, the code is
actually tricky, and there are a lot of things we need to take care
of.</p>
<p align="center">
<img src="lv1.jpeg" width="650">
</p>
<p>After every index iterator operation, it will call
<code>InitDataBlock()</code>function, the general role of this function
is to construction target data block iterator (which can be also called
second iterator) eventually call <code>SetDataIterator()</code>, set
<code>data_iter</code>. There are some edge cases of course:</p>
<ul>
<li>If current index iterator is not valid, set data iterator to
nullptr</li>
<li>If current index is valid but the data iterator has already been
set, and it is equal to <code>data_block_handle_</code>
(<code>data_block_handle_</code> is index value), do nothing. Else call
block function to construct a new iterator and set</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token double-colon punctuation">::</span><span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SetDataIterator</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    Slice handle <span class="token operator">=</span> index_iter_<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span>
        handle<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>data_block_handle_<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// data_iter_ is already constructed with this iterator, so</span>
      <span class="token comment">// no need to change anything</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      Iterator<span class="token operator">*</span> iter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>block_function_<span class="token punctuation">)</span><span class="token punctuation">(</span>arg_<span class="token punctuation">,</span> options_<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      data_block_handle_<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>handle<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">SetDataIterator</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Now that we understand how a two-level index works, let’s explore
further. Given an index iterator, we construct a data iterator, and atop
this structure, we can retrieve data entries sequentially. But what
happens when the first data block reaches its end? This is where the
functions <code>SkipEmptyDataBlocksForward()</code> and
<code>SkipEmptyDataBlocksBackward()</code> come into play. When the
<code>data_iter_</code> is either <code>nullptr</code> or invalid, these
functions move the index iterator to the next block—or to the previous
one if the function is <code>SkipEmptyDataBlocksBackward()</code>. Here
we got a new index iterator, so we also need call
<code>InitDataBlock()</code> to construct corresponding data iterator,
and then we set data iterator to first entry of this new data block.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token double-colon punctuation">::</span><span class="token function">SkipEmptyDataBlocksForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> <span class="token operator">!</span>data_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Move to next block</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">SetDataIterator</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    index_iter_<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> data_iter_<span class="token punctuation">.</span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><br></p>
<h3 id="table-iterator">Table iterator</h3>
<p>The table iterator is essentially a two-level iterator as described
earlier. To create a new two-level iterator, we start with an index
iterator, then add a block function—used to create a data block iterator
(<code>Table::BlockReader</code> in this case), the argument (the table
itself), and some options to control the behavior of the database.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Iterator<span class="token operator">*</span> <span class="token class-name">Table</span><span class="token double-colon punctuation">::</span><span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">NewTwoLevelIterator</span><span class="token punctuation">(</span>
      rep_<span class="token operator">-></span>index_block<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>comparator<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">&amp;</span>Table<span class="token double-colon punctuation">::</span>BlockReader<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Table<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The key functionality lies within the <code>BlockReader()</code>
function. Let’s break down this function step by step to understand its
logic:</p>
<p>Based on the <code>index_value</code> stored in the index iterator,
we decode it into a <code>BlockHandle</code> object. A
<code>BlockHandle</code> contains only two variables that help locate
the block:</p>
<ul>
<li>offset</li>
<li>size</li>
</ul>
<p>Now, we have two options regarding whether or not we use a
<code>block_cache</code> to store the block:</p>
<p>If the <code>cache_handle</code> is <code>nullptr</code>, we indeed
need to manually release this memory space. Therefore, we register a
<code>DeleteBlock()</code> function to the iterator.</p>
<p align="center">
<img src="lv2.jpeg" width="650">
</p>
<p>If we opt to use the <code>block_cache</code>, the initialization of
the data block starts with constructing a key to find it in the cache.
If the cache contains this key, we directly set the block; otherwise, we
must read the block from the disk and insert it into the cache for
future retrieval. Additionally, when utilizing <code>block_cache</code>
to build this iterator, we also need register a cleanup
function—<code>ReleaseBlock()</code> into iterator.</p>
<p align="center">
<img src="lv3.jpeg" width="950">
</p>
<p>Below is the code.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Iterator<span class="token operator">*</span> <span class="token class-name">Table</span><span class="token double-colon punctuation">::</span><span class="token function">BlockReader</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> index_value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Table<span class="token operator">*</span> table <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Table<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Cache<span class="token operator">*</span> block_cache <span class="token operator">=</span> table<span class="token operator">-></span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>block_cache<span class="token punctuation">;</span>
  Block<span class="token operator">*</span> block <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  Cache<span class="token double-colon punctuation">::</span>Handle<span class="token operator">*</span> cache_handle <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  BlockHandle handle<span class="token punctuation">;</span>
  Slice input <span class="token operator">=</span> index_value<span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> handle<span class="token punctuation">.</span><span class="token function">DecodeFrom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    BlockContents contents<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>block_cache <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// we choose to use cache here</span>
      <span class="token comment">// build lookup key</span>
      <span class="token keyword">char</span> cache_key_buffer<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>cache_key_buffer<span class="token punctuation">,</span> table<span class="token operator">-></span>rep_<span class="token operator">-></span>cache_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>cache_key_buffer <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> handle<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Slice <span class="token function">key</span><span class="token punctuation">(</span>cache_key_buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cache_key_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// lookup in cache</span>
      cache_handle <span class="token operator">=</span> block_cache<span class="token operator">-></span><span class="token function">Lookup</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_handle <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// find it</span>
        block <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Block<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>block_cache<span class="token operator">-></span><span class="token function">Value</span><span class="token punctuation">(</span>cache_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// not found</span>
        s <span class="token operator">=</span> <span class="token function">ReadBlock</span><span class="token punctuation">(</span>table<span class="token operator">-></span>rep_<span class="token operator">-></span>file<span class="token punctuation">,</span> options<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Block</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>contents<span class="token punctuation">.</span>cachable <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fill_cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            cache_handle <span class="token operator">=</span> block_cache<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> block<span class="token punctuation">,</span> block<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                               <span class="token operator">&amp;</span>DeleteCachedBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// we choose to not use cache here</span>
      s <span class="token operator">=</span> <span class="token function">ReadBlock</span><span class="token punctuation">(</span>table<span class="token operator">-></span>rep_<span class="token operator">-></span>file<span class="token punctuation">,</span> options<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Block</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
	
  <span class="token comment">// now we get the block, create iter and register cleanup function</span>
  Iterator<span class="token operator">*</span> iter<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    iter <span class="token operator">=</span> block<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>table<span class="token operator">-></span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_handle <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      iter<span class="token operator">-></span><span class="token function">RegisterCleanup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DeleteBlock<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      iter<span class="token operator">-></span><span class="token function">RegisterCleanup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ReleaseBlock<span class="token punctuation">,</span> block_cache<span class="token punctuation">,</span> cache_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    iter <span class="token operator">=</span> <span class="token function">NewErrorIterator</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> iter<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><br></p>
<h3 id="concatenating-iterator">Concatenating Iterator</h3>
<p>The Concatenating iterator itself functions as a two-level iterator.
The first level is the <code>LevelFileNumIterator</code> (a basic type
of iterator), which we have previously discussed. The second level is a
Table Iterator, constructed by the block function
<code>GetFileIterator()</code>.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> Iterator<span class="token operator">*</span> <span class="token function">GetFileIterator</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> the ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                                 the Slice<span class="token operator">&amp;</span> file_value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  TableCache<span class="token operator">*</span> cache <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>TableCache<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">NewErrorIterator</span><span class="token punctuation">(</span>
        <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"FileReader invoked with an unexpected value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> cache<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token function">DecodeFixed64</span><span class="token punctuation">(</span>file_value<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token function">DecodeFixed64</span><span class="token punctuation">(</span>file_value<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>In the <code>TableCache::NewIterator()</code> function, we use
<code>FindTable()</code> to locate the corresponding table based on
<code>file_number</code> and <code>file_size</code>. Once the table is
located, we create a table iterator and return it. This table iterator,
as previously described, is also a two-level iterator. Thus, the
Concatenating iterator could be considered a "three-level iterator." The
overall iteration scheme works as follows: based on the level file
number iterator, it invokes <code>GetFileIterator()</code> to create a
table iterator. We then iterate over this table iterator using the same
scheme as discussed in the <strong>Table Iterator</strong> chapter.</p>
<p><br></p>
<h3 id="reference">Reference</h3>
<ol type="1">
<li>https://kernelmaker.github.io/Leveldb_Iterator</li>
<li>https://zhuanlan.zhihu.com/p/45829937</li>
</ol>
<p><br></p>
<h3 id="todo">TODO</h3>
<ul class="task-list">
<li><label><input type="checkbox" checked="" /> Apr 23: Two level
iterator explanation</label></li>
<li><label><input type="checkbox" checked="" /> Apr 24: Table iterator
&amp; Concatenating iterator</label></li>
<li><label><input type="checkbox" checked="" /> Apr 25: Block iterator
&amp; Level file num iterator &amp; Memtable iterator</label></li>
<li><label><input type="checkbox" /> Apr 26: Conclusion</label></li>
</ul>

  </div>

</article>
  </div>
  <div class="right-content">
    <div id="toc" class="toc-wrapper"></div>
  <div>
</div>


          </div>
        </div>
      </div>
    </div>

     
  <button id="scroll-to-top" class="btn btn-top" aria-label="Scroll To Top">
    <i class="fas fa-arrow-up"></i>
  </button>
 

  </main>

  <div class="footer-wrapper">
  <div class="left-content"></div>
  <div class="right-content">
    <div>Copyright &copy;2024</div>
    <!-- <div>Powered By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> - Theme <a target="_blank" rel="noopener" href="https://github.com/thomasyu929/hexo-theme-peomas">Peomas</a></div> -->
  </div>
</div>

  <div id="searchModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Search</h5>
        <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-wrapper">
          <i class="fas fa-search"></i>
          <input id="search" class="search-input" type="text" placeholder="Input content to search..." />
        </div>
        <ul id="result" class="search-list-group result-wrapper">
        </ul>
      </div>
    </div>
  </div>
</div>

  
<script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.min.js"></script>


<script src="/js/prism.js"></script>



  
<script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css">

  
<script src="/js/nprogress.js"></script>



 
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">

 


<script src="/js/event.js"></script>


<script src="/js/search.js"></script>


<script src="/js/plugin.js"></script>



</body>

</html>