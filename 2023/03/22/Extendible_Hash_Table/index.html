<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="/img/AAA.png">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">


  
<link rel="stylesheet" href="/css/style.css">


  
  <title>CMU 15-445 Extendible Hash Table - Auzdora&#39;s Blog</title>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  <header>
    <nav id="navbar" class="navbar fixed-nav scrolling-navbar">
  <div class="container">
    <div class="mark-wrapper">
       
      <div class="title-mark">Auzdora</div>
    </div>
  
    <button id="menu-btn" class="btn menu-btn" type="button" data-bs-toggle="collapse" data-bs-target="#nav-menu">
      <div class="menu-icon"><span></span><span></span><span></span></div>
    </button>
  
    <div id="nav-menu" class="collapse menu-wrapper">
      <ul>
        
          <li>
            <a href="/">Home </a>
          </li>
        
          <li>
            <a href="/archives">Archives </a>
          </li>
        
          <li>
            <a href="/Life">Life </a>
          </li>
        
          <li>
            <a href="/tag">Tag </a>
          </li>
        
          <li>
            <a href="/about2">About </a>
          </li>
        
        <li class="search-icon">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#searchModal" aria-label="Search">
            <i class="fas fa-search"></i>
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

  </header>

  <main>
    <div class="container">
      <div id="main">
        <div class="row py-5">
          <div class="col">
            <div class="row">
  <div class="left-content">
    <article class="post-wrapper markdown-body">
  <h2 class="post-title">
    CMU 15-445 Extendible Hash Table
  </h2>
  <div class="post-meta">
    <time datetime="Invalid date Invalid date ">2023-03-22</time>
    
    
       
    
    
      
        <a class="tag" href="/tags/Database-Management-System/">Database Management System</a> 
       
    
    
  </div>
  
  <div id="content">
    <blockquote>
<p>最近在学习CMU的15-445 DB课程，在做Project1的Extendible Hash
Table的时候，由于是先看了课程，过了一个多星期才做的Lab，对extendible
hash
table只能说是知道大体的意思，并没有透彻的了解它，尤其是bucket指针和数据重分配这一部分，涉及到比较tricky的位运算，在一知半解的情况下实现它，完全没办法找到对应的bug，ConcurrentInsertFindTest和GetNumBucketsTest总是fail。又去参考了很多对可扩展哈希的文章，才发现自己一些细节是错误的。本篇文章尝试以我的理解说清楚extendible
hash table，并作为我的菜坑记录。</p>
</blockquote>
<h3 id="task">Task</h3>
<p>这一部分的任务就是搭建一个通用的存储unique
KV对的哈希表。我们需要实现哈希表的插入、删除以及查找操作。实验手册中并没有要求我们实现shrink部分，所以只需要关注如何扩展哈希表即可。代码在<code>scr/include/container/hash/extendible_hash_table.h</code>以及
<code>extendible_hash_table.cpp</code>下，实现之前建议先阅读这两个文件的代码和注释，明确我们的目标。</p>
<h3 id="overview-of-extendible-hash-table">Overview of Extendible Hash
Table</h3>
<p>在理解可扩展哈希表之前，我们需要了解几个概念。</p>
<ul>
<li><strong>Directory</strong>：是存放bucket指针的容器，可动态生长（以原大小的倍数作为增长率），容器的每个元素可用哈希值来索引。</li>
<li><strong>Bucket</strong>：桶。存放Key/value
pair的桶，数据结构层面是一个线性表。</li>
</ul>
<p>下面是一个简单的可扩展哈希表的示意图，具体不用关心它是怎么来的，先对它建立一个直观的印象即可。</p>
<p><img src="eht1.png" /></p>
<p>上图又出现两个概念：</p>
<ul>
<li><strong>Global Depth</strong>：假设global
depth为n，那么当前的directory必定有<span
class="math inline">\(2^n\)</span>个entry。例如，当前<span
class="math inline">\(n=2\)</span>，那么就有4个entry，<span
class="math inline">\(n=3\)</span>就有8个entry。同时，给定一个key，需要用global
depth取出这个key的低n位的二进制值。例如，一个key的二进制是10111，如果global
depth是3，通过<code>IndexOf(key)</code>函数，得到返回值的二进制值是111，即为7。这个值用来索引directory[111]位置的bucket。</li>
<li><strong>Local Depth</strong>：local depth指的是（假设local
depth为n），在当前的bucket之下，每个元素的key的低n位都是相同的。</li>
</ul>
<p>两者之间有什么关系呢？</p>
<ul>
<li>对于一个bucket来说，如果当前的global depth等于local
depth，那说明这个bucket只有一个指针指向它。</li>
<li>如果当前的global depth大于local depth，必定不止一个指针指向它。</li>
<li>计算当前bucket有几个指针指向它的公示是<span
class="math inline">\(2^{globalDepth-localDepth}\)</span>。</li>
</ul>
<p>Global depth和local
depth的概念就是这些，然而在实现算法的过程中还有对这些概念的应用，我们暂且先忽略，之后的部分会一一阐述。</p>
<h3 id="implementation-scheme">Implementation Scheme</h3>
<p>对于Bucket的Insert，Remove以及Find操作，熟悉一下C++的list容器相关操作就可以实现。不过有一个地方需要注意的是，实现bucket的Insert方法时，注释里说的是先检查key是否存在，如果存在就要更新value。这里如果先判断bucket是否满了，就会出现bug。因为如果一个bucket满了，但刚你要插入的key在这个bucket的中，先判断是否满的话就会直接返回，不会更新对应key的value，就会造成之后find的错误。</p>
<p>实现了Bucket的三个操作之后，就可以实现ExtendibleHashTable的三大操作了。为了确保线程安全，每一个操作应当加锁来保证。</p>
<p>这里阐述一下Insert的算法流程，然后结合一个具体的例子，分析算法可能遇到的情况。</p>
<ol type="1">
<li>尝试插入Key，若插入成功，返回即可，若不成功，执行步骤2。</li>
<li>判断当前<code>IndexOf(key)</code>指向的bucket下，该bucket是否满了。如果满了，执行步骤3。否则执行步骤7。</li>
<li>如果当前global depth等于local
depth，说明bucket已满，需要增长direcotry的大小。增加directory的global
depth，并将新增加的entry链接到对应的bucket。否则，继续执行步骤4。</li>
<li>记录当前的local mask，创建bucket1和bucket2，增加两个bucket的local
depth，增加num bucket的数量。取出之前满了的bucket中的元素，按照local
mask的标准将每个元素重新分配到bucket1和bucket2中。执行步骤5。</li>
<li>对每个链接到产生overflow的bucket的direcotry entry，按照local
mask的标准，重新分配指针指向。执行步骤6。</li>
<li>重新计算<code>IndexOf(key)</code>，执行步骤2。</li>
<li>插入指定的key/value pair。</li>
</ol>
<h3 id="example">Example</h3>
<p>这个例子来自于官方的Homework #2 - Question
3。假定每一个bucket的容量大小为2，且哈希函数用最低的g个二进制位，g指global
depth。</p>
<p>按顺序插入15，14，23，11，9。这几个数对应的二进制分别是，1111，1110，10111，1011，1001。</p>
<p><strong>STEP 1</strong>：首先插入15和14，第一步没什么问题。</p>
<p><img src="eht2.png" /></p>
<p><strong>STEP 2</strong>：接着插入23，23的二进制是10111，当前的global
depth是0，计算得到的<code>IndexOf(key)</code>是0，说明23要插入到directory的第0个entry中，但是这个entry所指向的bucket满了。我们执行步骤3（<strong><em>重复一下步骤3：如果当前global
depth等于local
depth，说明bucket已满，需要增长direcotry的大小。增加directory的global
depth，并将新增加的entry链接到对应的bucket。否则，继续执行步骤4</em></strong>）。</p>
<p><img src="eht3.png" /></p>
<p>这一步有一个很重要的点，新增长的entry怎么分配到对应的bucket？如果和上图的情况一样，从1增长到2，只需要把多出来的一个拉到唯一的bucket上就可以了，但如果从2到4，从4到8呢？多出来的若干个如何处理？其实只需要将多出来的一部分指针完全复制之前的一份就可以了。这样做法我觉得是可扩展哈希的比较重要的细节，由于可扩展哈希扩展direcotry时是按照当前大小的两倍进行扩展，新增长出来的部分作为之前directory的对等实体，每一个新的entry都对应了之前对应的entry，指向相同的bucket。唯一的不同就是之前的direcotry的索引最高位是0，扩展出来的最高位是1。</p>
<p><img src="eht4.png" /></p>
<p><strong>STEP 3</strong>：执行步骤4（<strong><em>记录当前的local
mask，创建bucket1和bucket2，增加两个bucket的local depth，增加num
bucket的数量。取出之前满了的bucket中的元素，按照local
mask的标准将每个元素重新分配到bucket1和bucket2中。执行步骤5</em></strong>）。</p>
<p>当前local
mask的计算方法是<code>1 &lt;&lt; local_depth</code>，其中的local
depth是指<strong>STEP 2</strong>图片中，扩展之前的local
depth，即为0。</p>
<p>为什么呢？因为在扩展之前，产生overflow的bucket中的数据，低local
depth个的二进制位完全相同，在<strong>STEP
2</strong>的图片例子中，1111和1110没有相同的低位二进制位，因此local
depth是0。现在要插入23（0b10111），由于bucket已经满了，所以我们需要分裂bucket、重分配KV
pair、重分配entry的指向。分裂了bucket，就产生两个bucket。</p>
<p>怎么放KV
pair呢？我们总不能乱放吧？我们肯定要有规律的去分配。1111和1110，由于之前local
depth为0，表明不需要参考任何二进制位，因此可以放到一个bucket里。当插入10111时，一个bucket放不下了，就需要两个bucket，为了可以高效的查询，当然是<strong>归类分配</strong>才行。按什么归类？当我们给事物归类的时候，我们会按属性归类，玩具为一类，家具为一类。二进制怎么归类呢？我们可以从最低位二进制位开始对比，之前不需要对比，现在我们至少需要对比一个二进制位，才能将3个二进制数分为两类（2个+1个，如果对比一个二进制位还不行，就继续增加local
depth）。local mask的意思就是，之前local
depth为0，不需要对比，但我现在要对比第一位，那么我就可以使用<code>1 &lt;&lt; local_depth</code>，1左移0位还是1，就是对比第一位二进制位。通过对比，1111和1110就不再是一类了，可以分别放入不同的bucket。</p>
<p><img src="eht5.png" /></p>
<p><strong>STEP
4</strong>：执行步骤5（<strong><em>对每个链接到产生overflow的bucket的direcotry
entry，按照local
mask的标准，重新分配指针指向。执行步骤6</em></strong>）。</p>
<p><img src="eht6.png" /></p>
<p><strong>STEP
5</strong>：执行步骤6，重新计算<code>IndexOf(key)</code>，由于改变了global
depth，新计算的IndexOf(key)是1，最后执行步骤2，判断1指向的bucket没满，执行步骤7，插入23。</p>
<p><img src="eht7.png" /></p>
<p><strong>STEP
6</strong>：接下来我们插入11（0b1011）。<strong>NOTE：这个例子在实现的过程中容易忽略掉</strong>。首先计算<code>IndexOf(key)</code>，得到结果为1，我们就要插入红色的bucket。但红色bucket满了，同时，global
depth等于local depth，因此需要扩展directory，执行步骤3。</p>
<p><img src="eht8.png" /></p>
<p>之前的local
depth我们比较最低位的二进制位，将1111和10111放入了一个bucket，由于该bucket产生了overflow，又分裂为两个bucket，我们就需要对这个产生overflow的bucket中的元素重新归类。正常情况下，产生overflow的bucket的中的元素可以被平均的分布到两个bucket中，但这个例子中，我们对比两个数的第二位，发现1111和10111最低的第二位仍然是1，那么还是将两者化为一类。并更新与overflow的bucket相关的directory
entry的指向。</p>
<p><img src="eht9.png" /></p>
<p>复杂的问题又来了，之前01和11的entry都指向一个bucket，在分裂的时候，我们怎么去redirect呢？答案是利用local
depth和local mask。<strong>分裂之前的local
depth为1（0b01），意味着指向这个bucket的最低一位二进制位都相同</strong>。01和11两个数的最低一位二进制位都是1。我们要分裂bucket，一定是bucket已经满了，也说明当前比较二进制位最低一位在将来不适用了，因为连上要插入的数，三个数的最低一位二进制位都是1，因此我们才需要local
mask，将1（0b01）左移local
depth位，变为2（0b10），意味着我们需要考量第二位二进制位才能区分三个数（这里的entry、global
depth还有local
depth之间的关系比较难理解）。<strong>想要redirect指向同一个bucket的所有entry，我们必须遍历一次directory</strong>。但并不是暴力遍历，通过观察可以发现，01和11刚好相差一个local
mask，而且01作为遍历的开始，可以通过<code>hash(key) &amp; (local_mask - 1)</code>计算得到。</p>
<p>为什么是<code>hash(key) &amp; (local_mask - 1)</code>呢？首先<code>hash(key)</code>可以理解为得到了key的二进制数，local
mask是由local depth得到的，local
depth表明的是存放在当前bucket中所有key的低位二进制位相等的个数。local
mask是下一个需要检查的二进制位的位置。同时我们也知道，既然key能插入这个bucket，<strong>那么说明key和存放于这个bucket中的keys是有共同性的</strong>，这个共同性就是：<strong>低local
depth位二进制数完全相同</strong>。local_mask -
1和key的二进制&amp;的结果就是在directory中，最开始的那个entry，因为这个entry的值完全等于<code>hash(key) &amp; (local_mask - 1)</code>。其余所有指向这个bucket的entry，唯一与这个最开始的不同就是：local
depth + 1位是0和1的区别。就是相差local mask。</p>
<p>啊，好复杂，感觉没有说清楚，后续可能更新一下，如果没懂可以私信我或者评论区讨论一下。</p>
<p>更新<code>IndexOf(key)</code>，由于global
index变为2，这时的index就是0b11，即第四个directory。进入步骤2。</p>
<p><strong>STEP
7</strong>：判断是否能插入蓝色bucket，很明显，bucket又满了，且global
depth等于local depth。进行扩展哈希表和分裂bucket。然后分配每一个KV
pair。</p>
<p><img src="eht10.png" /></p>
<p>最后更新<code>IndexOf(key)</code>，结果是0b011，插入绿色的bucket。</p>
<p><img src="eht11.png" /></p>
<p>之后的继续添加和扩展大同小异，重点还是理解entry index、global
depth和local depth的深层含义，还有相关位运算的思想。</p>
<h3 id="踩坑记录">踩坑记录</h3>
<ul>
<li>第一次实现的时候并没有考虑扩展后的指针指向问题，导致程序运行时访问到了nullptr的地址，报错。实际上directory的扩展本质上就是将原来的direcotry完完整整拷贝一份，不同的只是index不同。</li>
<li>Grade
scope做测试的时候，无论如何怎么调试都过不了ConcurrentInsertFindTest和GetNumBucketsTest，尝试着根据在线测试的输出在本地写了若干个对应的测试样例。还是没办法通过。最后阅读别人的文章才发现代码中分配元素的条件和重分配entry指针指向的条件有错误，根本原因还是没理解透彻extendible
hash table中的index、global depth和local
depth的内涵。以后一定要理解全部的算法内容再考虑代码实现，尤其是细节部分，de这样的bug简直是痛苦。</li>
<li>在算法的概述中，有涉及到循环插入的过程。在上面的例子中就是插入1011时的情况。判断一个bucket满了，分裂bucket后，将产生overflow的bucket中的元素根据local
depth重新分配，结果全部都分配到一个bucket中。这时候如果还是尝试插入1011，是失败的。因此需要通过while迭代，也就是test
case中的multi split test。第一次实现的时候并没有考虑到这个问题。</li>
</ul>
<p>遵守课程的条例，不公开源码，但我把自己写的相关测试样例放在下面，写的比较粗糙，因为是debug太痛苦时写的。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">TEST</span><span class="token punctuation">(</span>ExtendibleHashTableTest<span class="token punctuation">,</span> InsertMultipleSplitTest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">auto</span> table <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ExtendibleHashTable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetNumBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetLocalDepth</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetLocalDepth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetLocalDepth</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetLocalDepth</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">TEST</span><span class="token punctuation">(</span>ExtendibleHashTableTest<span class="token punctuation">,</span> ConcurrentInsertFindTest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> num_runs <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> num_threads <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

  <span class="token comment">// Run concurrent test multiple times to guarantee correctness.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> run <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> run <span class="token operator">&lt;</span> num_runs<span class="token punctuation">;</span> run<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">auto</span> table <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ExtendibleHashTable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">></span> threads<span class="token punctuation">;</span>
    threads<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tid <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> tid<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      threads<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> val<span class="token punctuation">;</span>
        table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span>table<span class="token operator">-></span><span class="token function">Find</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span>table<span class="token operator">-></span><span class="token function">GetGlobalDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">int</span> val<span class="token punctuation">;</span>
      <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span>table<span class="token operator">-></span><span class="token function">Find</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">TEST</span><span class="token punctuation">(</span>ExtendibleHashTableTest<span class="token punctuation">,</span> ConcurrentInsertFind2Test<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> num_runs <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> num_threads <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

  <span class="token comment">// Run concurrent test multiple times to guarantee correctness.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> run <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> run <span class="token operator">&lt;</span> num_runs<span class="token punctuation">;</span> run<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">auto</span> table <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ExtendibleHashTable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">></span> threadsInsert<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">></span> threadsFind<span class="token punctuation">;</span>
    threadsInsert<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadsFind<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tid <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> tid<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      threadsInsert<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> tid <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>tid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      threadsInsert<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tid <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> tid<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      threadsFind<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> tid <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>tid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">int</span> val<span class="token punctuation">;</span>
          <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span>table<span class="token operator">-></span><span class="token function">Find</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      threadsFind<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">TEST</span><span class="token punctuation">(</span>ExtendibleHashTableTest<span class="token punctuation">,</span> GetNumBucketsTest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">auto</span> table <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ExtendibleHashTable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetNumBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetNumBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"j"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetNumBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"k"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  table<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> table<span class="token operator">-></span><span class="token function">GetNumBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

  </div>

</article>
  </div>
  <div class="right-content">
    <div id="toc" class="toc-wrapper"></div>
  <div>
</div>


          </div>
        </div>
      </div>
    </div>

     
  <button id="scroll-to-top" class="btn btn-top" aria-label="Scroll To Top">
    <i class="fas fa-arrow-up"></i>
  </button>
 

  </main>

  <div class="footer-wrapper">
  <div class="left-content"></div>
  <div class="right-content">
    <div>Copyright &copy;2024</div>
    <!-- <div>Powered By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> - Theme <a target="_blank" rel="noopener" href="https://github.com/thomasyu929/hexo-theme-peomas">Peomas</a></div> -->
  </div>
</div>

  <div id="searchModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Search</h5>
        <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-wrapper">
          <i class="fas fa-search"></i>
          <input id="search" class="search-input" type="text" placeholder="Input content to search..." />
        </div>
        <ul id="result" class="search-list-group result-wrapper">
        </ul>
      </div>
    </div>
  </div>
</div>

  
<script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.min.js"></script>


<script src="/js/prism.js"></script>



  
<script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css">

  
<script src="/js/nprogress.js"></script>



 
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">

 


<script src="/js/event.js"></script>


<script src="/js/search.js"></script>


<script src="/js/plugin.js"></script>



</body>

</html>